//book_screen.dart
import 'package:flutter/material.dart';

class BookScreen extends StatelessWidget {
  const BookScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('å›³é‘‘')),
      body: const Center(
        child: Text(
          'ã“ã“ã«å›³é‘‘ã®å†…å®¹ã‚’è¡¨ç¤º',
          style: TextStyle(fontSize: 20),
        ),
      ),
    );
  }
}




//creator_splash_screen.dart
import 'dart:async';
import 'package:flutter/material.dart';
import 'splash_screen.dart'; 

class CreatorSplashScreen extends StatefulWidget {
  const CreatorSplashScreen({super.key});

  @override
  State<CreatorSplashScreen> createState() => _CreatorSplashScreenState();
}

class _CreatorSplashScreenState extends State<CreatorSplashScreen> {
  @override
  void initState() {
    super.initState();
    Timer(const Duration(seconds: 2), _navigateToNextScreen);
  }

  void _navigateToNextScreen() {
    Navigator.of(context).pushReplacement(
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) => SplashScreen(),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(
            opacity: animation,
            child: child,
          );
        },
        transitionDuration: const Duration(milliseconds: 1000),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Center(
        child: Image.asset(
          'assets/images/team_name2.jpg',
          width: 200,
        ),
      ),
    );
  }
}




//genre_select_screen.dart
// genre_select_screen.dart

import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:gakumon_app_01/screens/home_screen.dart';

class GenreSelectScreen extends StatefulWidget {
  const GenreSelectScreen({Key? key}) : super(key: key);

  @override
  State<GenreSelectScreen> createState() => _GenreSelectScreenState();
}

class _GenreSelectScreenState extends State<GenreSelectScreen> {
  // æœ€å¤§4ã¤ã®ã‚¸ãƒ£ãƒ³ãƒ«å…¥åŠ›ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©
  final List<TextEditingController> _controllers =
      List.generate(4, (_) => TextEditingController());
  bool _isLoading = false;
  
  get monstersRef => null;

  @override
  void initState() {
    super.initState();
    // æœ€åˆã®TextFieldã ã‘ã«åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆ
    _controllers[0].text = 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°';
  }

  // Firestoreã«ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ä¿å­˜ã—ã€åˆæœŸãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ä½œæˆ/æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
  Future<void> _saveGenres() async {
  setState(() {
    _isLoading = true;
  });

  // å…¥åŠ›ã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«åã‚’å–å¾—ï¼ˆç©ºç™½ã¯é™¤å¤–ï¼‰
  final genres = _controllers
      .map((c) => c.text.trim())
      .where((text) => text.isNotEmpty)
      .toSet()
      .toList(); // é‡è¤‡æ’é™¤

  if (genres.isEmpty) {
    setState(() { _isLoading = false; });
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('ã‚¸ãƒ£ãƒ³ãƒ«ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„')),
    );
    return;
  }

  try {
    final monstersRef = FirebaseFirestore.instance.collection('monsters');

    // --- æ—¢å­˜ã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å…¨ã¦å‰Šé™¤ ---
    // 1. ç¾åœ¨ã®å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
    final existingDocs = await monstersRef.get();
    
    // 2. å‰Šé™¤ç”¨ã®ãƒãƒƒãƒã‚’ä½œæˆ
    final deleteBatch = FirebaseFirestore.instance.batch();
    
    // 3. æ—¢å­˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å…¨ã¦å‰Šé™¤ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
    for (var doc in existingDocs.docs) {
      deleteBatch.delete(doc.reference);
    }
    
    // 4. æ—¢å­˜ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ä¸€æ‹¬å‰Šé™¤ã‚’å®Ÿè¡Œ
    await deleteBatch.commit(); 

    // --- æ–°ã—ã„ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ä¿å­˜ ---
    final writeBatch = FirebaseFirestore.instance.batch();
    for (var genre in genres) {
      final docRef = monstersRef.doc(genre);
      writeBatch.set(docRef, {
        'genre': genre,
        'level': 0,
        'experience': 0,
        'last_fed': FieldValue.serverTimestamp(),
      });
    }
    await writeBatch.commit();

    if (mounted) {
      // ä¿å­˜æˆåŠŸå¾Œã€ãƒ›ãƒ¼ãƒ ç”»é¢ã¸é·ç§»
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (context) => const HomeScreen()),
      );
    }
  } catch (e) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: $e')),
      );
    }
  } finally {
    if (mounted) {
      setState(() { _isLoading = false; });
    }
  }
}


  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('å­¦ç¿’ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠ')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            const Text(
              'è‚²ã¦ãŸã„ã‚¸ãƒ£ãƒ³ãƒ«ã‚’4ã¤ã¾ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
              style: TextStyle(fontSize: 16),
            ),
            const SizedBox(height: 20),
            Expanded(
              child: ListView(
                children: [
                  for (int i = 0; i < 4; i++) ...[
                    TextField(
                      controller: _controllers[i],
                      decoration: InputDecoration(
                          labelText: i == 0 
                          ? 'ã‚¸ãƒ£ãƒ³ãƒ« ${i + 1} (ä¾‹: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°)' // 1ã¤ç›®ã«ã¯ä¾‹ã‚’è¡¨ç¤º
                          : 'ã‚¸ãƒ£ãƒ³ãƒ« ${i + 1}', // 2ã¤ç›®ä»¥é™ã¯ä¾‹ãªã—
                        border: const OutlineInputBorder(),
                      ),
                    ),
                    const SizedBox(height: 12),
                  ],
                ],
              ),
            ),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: _isLoading ? null : _saveGenres,
              child: _isLoading
                  ? const SizedBox(
                      width: 20,
                      height: 20,
                      child: CircularProgressIndicator(
                        color: Colors.white,
                        strokeWidth: 2,
                      ),
                    )
                  : const Text('ä¿å­˜ã—ã¦è‚²ã¦ã‚‹', style: TextStyle(fontSize: 18)),
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  @override
  void dispose() {
    for (var controller in _controllers) {
      controller.dispose();
    }
    super.dispose();
  }
}




//home_screen.dart
// lib/screens/home_screen.dart

import 'package:flutter/material.dart';

import 'monster_screen.dart';
import 'book_screen.dart';
import 'timer_screen.dart';
import 'settings_screen.dart';
import 'stomach_screen.dart';

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0ãŒæœ€åˆã®ã‚¿ãƒ–ï¼‰
  int _selectedIndex = 0;

  // å„ã‚¿ãƒ–ã§è¡¨ç¤ºã™ã‚‹ç”»é¢ã®ãƒªã‚¹ãƒˆ
  // late final ã§ initState å†…ã§ã®åˆæœŸåŒ–ã‚’ä¿è¨¼
  late final List<Widget> _widgetOptions;

  @override
  void initState() {
    super.initState();
    // è¡¨ç¤ºã™ã‚‹ç”»é¢ã®ãƒªã‚¹ãƒˆã‚’å®šç¾©
    _widgetOptions = <Widget>[
      _buildMainContent(), // 0: ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
      const BookScreen(),    // 1: ãšã‹ã‚“ç”»é¢
      const TimerScreen(),   // 2: ã‚¿ã‚¤ãƒãƒ¼ç”»é¢
      const SettingsScreen(),// 3: è¨­å®šç”»é¢
    ];
  }

  // ã‚¿ãƒ–ãŒã‚¿ãƒƒãƒ—ã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index; // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    });
  }

  // ãƒ›ãƒ¼ãƒ ã‚¿ãƒ–ï¼ˆæœ€åˆã®ç”»é¢ï¼‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†
  Widget _buildMainContent() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          GestureDetector(
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const StomachScreen()),
              );
            },
            child: Image.asset(
              'assets/images/logo1.gif',
              width: 250,
              height: 250,
              fit: BoxFit.contain,
            ),
          ),
          const SizedBox(height: 40),
          ElevatedButton(
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const MonsterScreen()),
              );
            },
            child: const Text('è‚²æˆ', style: TextStyle(fontSize: 18)),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
     
      body: Center(
        // é¸æŠã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        child: _widgetOptions.elementAt(_selectedIndex),
      ),      
      bottomNavigationBar: BottomNavigationBar(
        // å„ãƒœã‚¿ãƒ³ã®è¨­å®š
        items: const <BottomNavigationBarItem>[
          BottomNavigationBarItem(
            icon: Icon(Icons.home),
            label: 'ãƒ›ãƒ¼ãƒ ',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.book),
            label: 'ãšã‹ã‚“',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.timer),
            label: 'ã‚¿ã‚¤ãƒãƒ¼',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.settings),
            label: 'ã›ã£ã¦ã„',
          ),
        ],
        currentIndex: _selectedIndex, // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ–
        onTap: _onItemTapped,         // ã‚¿ãƒƒãƒ—æ™‚ã®å‡¦ç†
        
        // --- ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ ---
        type: BottomNavigationBarType.fixed, // ãƒœã‚¿ãƒ³ãŒ4ã¤ä»¥ä¸Šã§ã‚‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å›ºå®š
        selectedItemColor: Theme.of(context).colorScheme.primary, // é¸æŠä¸­ã®è‰²
        unselectedItemColor: Colors.grey, // é¸æŠã•ã‚Œã¦ã„ãªã„ã¨ãã®è‰²
        showUnselectedLabels: true, // é¸æŠã•ã‚Œã¦ã„ãªãã¦ã‚‚ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
      ),     
    );
  }
}





knowledge_input_screen.dart
// knowledge_input_screen.dart

import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart'; 

class KnowledgeInputScreen extends StatefulWidget {
  final List<String> genres; // å¤–éƒ¨ã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 
  final String initialGenre; // æœ€åˆã«é¸æŠã™ã‚‹ã‚¸ãƒ£ãƒ³ãƒ«
  
  const KnowledgeInputScreen({
    super.key, 
    required this.genres, 
    required this.initialGenre,
  });

  @override
  State<KnowledgeInputScreen> createState() => _KnowledgeInputScreenState();
}

class _KnowledgeInputScreenState extends State<KnowledgeInputScreen> {
  final TextEditingController _textController = TextEditingController();
  String? _selectedGenre; // é¸æŠã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«

  

  @override
  void initState() {
    super.initState();
    // ç”»é¢é–‹å§‹æ™‚ã«åˆæœŸã‚¸ãƒ£ãƒ³ãƒ«ã‚’è¨­å®š
    _selectedGenre = widget.initialGenre; 
  }

  Future<void> _feedMonster() async {
    final text = _textController.text.trim();
    final genre = _selectedGenre; 

    if (text.isEmpty || genre == null) { 
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('å­¦ã‚“ã å†…å®¹ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„')),
      );
      return;
    }

    // 1. çŸ¥è­˜ã®è¨˜éŒ²
    await FirebaseFirestore.instance.collection('knowledge').add({
      'knowledge': text, 
      'genre': genre,
      'timestamp': FieldValue.serverTimestamp(),
    });

    // 2. ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®æˆé•·ãƒ­ã‚¸ãƒƒã‚¯ (é¸æŠã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ã§ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°)
    try {
      await FirebaseFirestore.instance.runTransaction((transaction) async {
        // é¸æŠã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«åï¼ˆgenreï¼‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§
        final monsterRef = FirebaseFirestore.instance.collection('monsters').doc(genre);
        final monsterSnapshot = await transaction.get(monsterRef);

        if (!monsterSnapshot.exists) {
            // ã‚¸ãƒ£ãƒ³ãƒ«ã«è©²å½“ã™ã‚‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒã„ãªã„å ´åˆã¯å‡¦ç†ã—ãªã„
            return;
        }

        // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨æ›´æ–°
        int currentExp = (monsterSnapshot.data()?['experience'] as int? ?? 0);
        int currentLevel = (monsterSnapshot.data()?['level'] as int? ?? 0);
        
        currentExp += 10; // çµŒé¨“å€¤ã‚’åŠ ç®—
        
        if (currentExp >= 100) { // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¡ä»¶
          currentLevel += 1;
          currentExp = 0;
        }

        transaction.update(monsterRef, {
          'experience': currentExp,
          'level': currentLevel,
          'last_fed': FieldValue.serverTimestamp(),
        });
      });
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®æˆé•·è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: $e')),
        );
      }
    }


    if (mounted) {
      // çŸ¥è­˜ã®å…¥åŠ›ã«æˆåŠŸã—ãŸã‚‰å‰ã®ç”»é¢ã«æˆ»ã‚‹
      Navigator.pop(context);
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Scaffold(
      appBar: AppBar(
        title: const Text('çŸ¥è­˜ã®å…¥åŠ›'),
        backgroundColor: theme.colorScheme.primary,
        foregroundColor: theme.colorScheme.onPrimary,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            // ... (æ—¢å­˜ã®TextField) ...
            TextField(
              controller: _textController,
              decoration: const InputDecoration(
                labelText: 'å­¦ã‚“ã ã“ã¨ã‚’å…¥åŠ›',
                border: OutlineInputBorder(),
              ),
              maxLines: 5,
            ),
            const SizedBox(height: 20),
            
            // ğŸ‘‡ ä¿®æ­£: ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®itemsã« widget.genres ã‚’ä½¿ç”¨
            DropdownButtonFormField<String>(
              value: _selectedGenre,
              decoration: const InputDecoration(
                labelText: 'ã‚¸ãƒ£ãƒ³ãƒ«',
                border: OutlineInputBorder(),
              ),
              // å¤–éƒ¨ã‹ã‚‰æ¸¡ã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
              items: widget.genres.map((String genre) { 
                return DropdownMenuItem<String>(
                  value: genre,
                  child: Text(genre),
                );
              }).toList(),
              onChanged: (String? newValue) {
                setState(() {
                  _selectedGenre = newValue;
                });
              },
            ),
            const SizedBox(height: 30),
            ElevatedButton(
              style: ElevatedButton.styleFrom(
                backgroundColor: theme.colorScheme.primary,
                foregroundColor: theme.colorScheme.onPrimary,
                padding: const EdgeInsets.symmetric(vertical: 16.0),
                textStyle: const TextStyle(fontSize: 16),
                minimumSize: const Size(400, 48), 
              ),
              onPressed: _feedMonster,
              child: const Text('ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«é£Ÿã¹ã•ã›ã‚‹ï¼'),
            ),
          ],
        ),
      ),
    );
  }

  @override
  void dispose() {
    _textController.dispose();
    super.dispose();
  }
}







//monster_screen.dart
// monster_screen.dart

import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'knowledge_input_screen.dart';
import 'genre_select_screen.dart'; // æ–°ã—ãä½œæˆã—ãŸç”»é¢ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

class MonsterScreen extends StatefulWidget {
  const MonsterScreen({super.key});

  @override
  State<MonsterScreen> createState() => _MonsterScreenState();
}

class _MonsterScreenState extends State<MonsterScreen> {
  // Firestoreã‹ã‚‰ç™»éŒ²æ¸ˆã¿ã®ã‚¸ãƒ£ãƒ³ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
  Future<List<String>> _fetchGenres() async {
    // 'monsters'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã™ã¹ã¦å–å¾—
    final querySnapshot = await FirebaseFirestore.instance
        .collection('monsters') 
        .get();

    List<String> fetchedGenres = [];
    for (var doc in querySnapshot.docs) {
      final data = doc.data();
      // 'genre'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«åã‚’å–å¾—ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã§ã‚‚è‰¯ã„ãŒã€æ±ç”¨æ€§ã®ãŸã‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼‰
      if (data.containsKey('genre') && data['genre'] is String) {
        fetchedGenres.add(data['genre'] as String);
      } else {
        // 'genre'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’ä½¿ç”¨ã™ã‚‹ï¼ˆGenreSelectScreenã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
        fetchedGenres.add(doc.id);
      }
    }
    // ç©ºã®ã‚¸ãƒ£ãƒ³ãƒ«åã‚„é‡è¤‡ã‚’æ’é™¤
    return fetchedGenres.where((g) => g.isNotEmpty).toSet().toList();
  }

  // çŸ¥è­˜ã‚’ã‚ã’ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
  void _onFeedMonsterPressed() async {
    // ãƒ­ãƒ¼ãƒ‰ä¸­UIã‚’ä¸€æ™‚çš„ã«è¡¨ç¤º
    final scaffoldMessenger = ScaffoldMessenger.of(context);
    scaffoldMessenger.showSnackBar(
      const SnackBar(content: Text('ã‚¸ãƒ£ãƒ³ãƒ«æƒ…å ±ã‚’ç¢ºèªä¸­...'), duration: Duration(seconds: 1)),
    );
    
    final genres = await _fetchGenres();
    
    // ãƒ­ãƒ¼ãƒ‰ä¸­UIã‚’éè¡¨ç¤º
    scaffoldMessenger.hideCurrentSnackBar();

    if (context.mounted) {
      if (genres.isEmpty) {
        // ã‚¸ãƒ£ãƒ³ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠç”»é¢ã¸
        Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => const GenreSelectScreen()),
        );
      } else {
        // ã‚¸ãƒ£ãƒ³ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€çŸ¥è­˜å…¥åŠ›ç”»é¢ã¸ã‚¸ãƒ£ãƒ³ãƒ«ãƒªã‚¹ãƒˆã‚’æ¸¡ã—ã¦é·ç§»
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => KnowledgeInputScreen(
              genres: genres,
              initialGenre: genres.first, // æœ€åˆã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’åˆæœŸå€¤ã¨ã—ã¦æ¸¡ã™
            ),
          ),
        );
      }
    }
  }

  // æ—¢å­˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯Stateå†…ã«ç§»å‹•ã¾ãŸã¯ä¿æŒ
  Widget _buildLatestKnowledgeDisplay(ThemeData theme) {
    // ... æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ (çŸ¥è­˜ã®æœ€æ–°è¡¨ç¤º StreamBuilder) ...
    return StreamBuilder<QuerySnapshot>(
      stream: FirebaseFirestore.instance
          .collection('knowledge')
          .orderBy('timestamp', descending: true)
          .limit(1)
          .snapshots(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return CircularProgressIndicator(
            valueColor:
                AlwaysStoppedAnimation<Color>(theme.colorScheme.primary),
          );
        }
        if (snapshot.hasError) {
          return Text(
            'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            style: TextStyle(color: theme.colorScheme.error, fontSize: 20),
          );
        }
        if (!snapshot.hasData || snapshot.data!.docs.isEmpty) {
          return Text(
            'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¯ã¾ã ç©ºè…¹ã ...',
            style: TextStyle(
              fontSize: 20,
              color: theme.colorScheme.onBackground,
            ),
          );
        }
        final latestKnowledge = snapshot.data!.docs.first;
        
        final text = latestKnowledge['knowledge'] as String? ?? 'ãƒ‡ãƒ¼ã‚¿ãªã—';
        final genre = latestKnowledge['genre'] as String? ?? 'ä¸æ˜';

        return Text(
          'ã€Œ$textã€($genre) ã‚’é£Ÿã¹ãŸï¼',
          style: TextStyle(
            fontSize: 20,
            color: theme.colorScheme.onBackground,
          ),
        );
      },
    );
  }


  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Scaffold(
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Align(
                alignment: Alignment.topLeft,
                child: SafeArea(
                  child: IconButton(
                    icon: Icon(
                      Icons.arrow_back,
                      color: theme.colorScheme.primary,
                      size: 32,
                    ),
                    onPressed: () {
                      Navigator.pop(context);
                    },
                  ),
                ),
              ),
              const Spacer(),
              Image.asset(
                'assets/images/logo1.gif',
                width: 200,
                height: 200,
                fit: BoxFit.contain,
              ),
              const SizedBox(height: 30),
              // æœ€æ–°ã®çŸ¥è­˜è¡¨ç¤º
              _buildLatestKnowledgeDisplay(theme),
              const SizedBox(height: 40),
              // çŸ¥è­˜ã‚’ã‚ã’ã‚‹ãƒœã‚¿ãƒ³
              ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: theme.colorScheme.secondary,
                  foregroundColor: theme.colorScheme.onSecondary,
                  padding: const EdgeInsets.symmetric(vertical: 16.0, horizontal: 30.0),
                  textStyle: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                ),
                //  _onFeedMonsterPressedã‚’å‘¼ã³å‡ºã™
                onPressed: _onFeedMonsterPressed, 
                child: const Text('çŸ¥è­˜ã‚’ã‚ã’ã‚‹'),
              ),
              const SizedBox(height: 16),
              const Spacer(),
            ],
          ),
        ),
      ),
    );
  }
}



//splash_screen.dart
// lib/screens/splash_screen.dart

import 'package:flutter/material.dart';
import 'package:gakumon_app_01/screens/genre_select_screen.dart';

class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
 
    _controller = AnimationController(
      duration: const Duration(seconds: 2), 
      vsync: this,
    );

   
    _animation = CurvedAnimation(
      parent: _controller,
      curve: Curves.easeIn,
    );

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    _controller.forward();
  }

  @override
  void dispose() {    
    _controller.dispose();
    super.dispose();
  }

  void navigateToHome() {
    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (context) => const GenreSelectScreen()),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: InkWell(
        onTap: navigateToHome,       
        child: FadeTransition(
          opacity: _animation, 
          child: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text(
                  'ãŒããƒ¢ãƒ³',
                  style: Theme.of(context).textTheme.headlineMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                ),
                const SizedBox(height: 24),
                Image.asset('assets/images/logo1.gif', width: 150),
                const SizedBox(height: 48),
                Text(
                  'ã‚¿ãƒƒãƒ—ã—ã¦ã¯ã˜ã‚ã‚‹',
                  style: Theme.of(context).textTheme.bodyLarge,
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}




//stomach_screen.dart
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:intl/intl.dart';

class StomachScreen extends StatefulWidget {
  const StomachScreen({super.key});

  @override
  State<StomachScreen> createState() => _StomachScreenState();
}

class _StomachScreenState extends State<StomachScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // åˆ©ç”¨å¯èƒ½ãªã‚¸ãƒ£ãƒ³ãƒ«ãƒªã‚¹ãƒˆ (Firestoreã‹ã‚‰å–å¾—)
  List<String> _availableGenres = []; 
  // ç¾åœ¨é¸æŠä¸­ã®ã‚¸ãƒ£ãƒ³ãƒ« ('å…¨ã¦'ã®å ´åˆã¯å…¨è¡¨ç¤º)
  String? _selectedGenre; 
  // ã‚¸ãƒ£ãƒ³ãƒ«ãƒ­ãƒ¼ãƒ‰ä¸­ãƒ•ãƒ©ã‚°
  bool _isLoadingGenres = true; 

  @override
  void initState() {
    super.initState();
    _fetchGenres(); // ç”»é¢èµ·å‹•æ™‚ã«ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
  }

  // monstersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
  Future<void> _fetchGenres() async {
    try {
      final querySnapshot = await _firestore.collection('monsters').get();
      List<String> fetchedGenres = [];
      for (var doc in querySnapshot.docs) {
        final data = doc.data();
        if (data.containsKey('genre') && data['genre'] is String) {
          fetchedGenres.add(data['genre'] as String);
        } else {
          fetchedGenres.add(doc.id);
        }
      }
      
      if (mounted) {
        setState(() {
          // é¸æŠè‚¢ã®æœ€åˆã«ã€Œå…¨ã¦ã€ã‚’è¿½åŠ ã—ã€åˆæœŸé¸æŠå€¤ã‚’ã€Œå…¨ã¦ã€ã«è¨­å®š
          _availableGenres = ['å…¨ã¦', ...fetchedGenres.toSet().toList()]; 
          _selectedGenre = _availableGenres.first; 
          _isLoadingGenres = false;
        });
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          _isLoadingGenres = false;
        });
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      }
    }
  }

  // é¸æŠã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«ã«åŸºã¥ã„ã¦Firestoreã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰
  Stream<QuerySnapshot> _getTodaysEntriesStream() {
    DateTime now = DateTime.now();
    DateTime startOfDay = DateTime(now.year, now.month, now.day);
    DateTime endOfDay = startOfDay.add(const Duration(days: 1));

    Query query = _firestore
        .collection('knowledge') 
        .where('timestamp', isGreaterThanOrEqualTo: startOfDay)
        .where('timestamp', isLessThan: endOfDay);
        
    // ã€ä¿®æ­£ãƒ»è¿½åŠ ã€‘ã€Œå…¨ã¦ã€ä»¥å¤–ã®ã‚¸ãƒ£ãƒ³ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ã‚’è¿½åŠ 
    if (_selectedGenre != null && _selectedGenre != 'å…¨ã¦') {
      query = query.where('genre', isEqualTo: _selectedGenre);
    }

    return query
        .orderBy('timestamp', descending: true)
        .snapshots();
  }

  @override
  Widget build(BuildContext context) {
    // ã€ä¿®æ­£ã€‘ã‚¸ãƒ£ãƒ³ãƒ«ãƒ­ãƒ¼ãƒ‰ä¸­ã®å ´åˆã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    if (_isLoadingGenres) {
      return Scaffold(
        appBar: AppBar(title: const Text('ä»Šæ—¥ã®èƒƒã®è¨˜éŒ²')),
        body: const Center(child: CircularProgressIndicator()),
      );
    }
    
    // ã‚¸ãƒ£ãƒ³ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã®ãƒ¡ã‚¤ãƒ³UI
    return Scaffold(
      appBar: AppBar(title: const Text('ä»Šæ—¥ã®èƒƒã®è¨˜éŒ²')),
      body: Column(
        children: [
          // ã€è¿½åŠ ã€‘ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
            child: DropdownButtonFormField<String>(
              decoration: const InputDecoration(
                labelText: 'è¡¨ç¤ºã‚¸ãƒ£ãƒ³ãƒ«',
                border: OutlineInputBorder(),
              ),
              value: _selectedGenre,
              // _availableGenresã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é …ç›®ã¨ã—ã¦ä½¿ç”¨
              items: _availableGenres.map((String genre) {
                return DropdownMenuItem<String>(
                  value: genre,
                  child: Text(genre),
                );
              }).toList(),
              onChanged: (String? newValue) {
                if (newValue != null) {
                  setState(() {
                    _selectedGenre = newValue;
                    // StreamBuilderãŒæ–°ã—ã„ã‚¯ã‚¨ãƒªã§è‡ªå‹•çš„ã«ãƒªãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã™
                  });
                }
              },
            ),
          ),
          
          // StreamBuilderã‚’Expandedã§å›²ã¿ã€æ®‹ã‚Šã‚¹ãƒšãƒ¼ã‚¹ã‚’å æœ‰ã•ã›ã‚‹
          Expanded(
            child: StreamBuilder<QuerySnapshot>(
              stream: _getTodaysEntriesStream(),
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(child: CircularProgressIndicator());
                }
                if (snapshot.hasError) {
                  return Center(child: Text('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${snapshot.error}'));
                }

                final entries = snapshot.data!.docs;
                final entryCount = entries.length;

                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // ã€è¿½åŠ ã€‘ä»Šæ—¥ã®ä»¶æ•°ã‚µãƒãƒªãƒ¼
                    Padding(
                      padding: const EdgeInsets.only(left: 16.0, right: 16.0, bottom: 8.0),
                      child: Text(
                        '${_selectedGenre == 'å…¨ã¦' ? 'ä»Šæ—¥' : 'ä»Šæ—¥ã®${_selectedGenre}ã‚¸ãƒ£ãƒ³ãƒ«'}ã®è¨˜éŒ²: ${entryCount}ä»¶',
                        style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                      ),
                    ),
                    
                    Expanded(
                      child: entries.isEmpty
                          ? const Center(
                              child: Text(
                                'ä»Šæ—¥ã®è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“',
                                style: TextStyle(fontSize: 18, color: Colors.grey),
                              ),
                            )
                          : ListView.builder(
                              itemCount: entryCount,
                              itemBuilder: (context, index) {
                                var data = entries[index].data() as Map<String, dynamic>;
                                String content = data['knowledge'] ?? 'å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“';
                                String genre = data['genre'] ?? 'ä¸æ˜'; // è¨˜éŒ²ã•ã‚ŒãŸã‚¸ãƒ£ãƒ³ãƒ«
                                
                                String formattedTime = '';
                                if (data['timestamp'] != null) {
                                  formattedTime = DateFormat('HH:mm').format((data['timestamp'] as Timestamp).toDate());
                                }

                                return Card(
                                  margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                                  child: ListTile(
                                    title: Text(content),
                                    // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã«æ™‚åˆ»ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã‚’è¡¨ç¤º
                                    subtitle: Text('$formattedTime | ã‚¸ãƒ£ãƒ³ãƒ«: $genre'),
                                  ),
                                );
                              },
                            ),
                    ),
                  ],
                );
              },
            ),
          ),
        ],
      ),
    );
  }
}
